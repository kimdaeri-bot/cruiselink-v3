<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„ ë°• ìƒì„¸ - í¬ë£¨ì¦ˆë§í¬</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸš¢</text></svg>">
</head>
<body>
  <div id="header"></div>
  <div id="content">
    <div class="loading" style="padding:100px 20px"><div class="loading-spinner"></div><p>ì„ ë°• ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div>
  </div>
  <div id="ctaSection"></div>
  <div id="footer"></div>

  <script src="assets/data/translations.js"></script>
  <script src="assets/js/api.js"></script>
  <script src="assets/js/components.js"></script>
  <script>
    document.getElementById('header').innerHTML = Components.header('ships');
    document.getElementById('footer').innerHTML = Components.footer();
    document.getElementById('ctaSection').innerHTML = Components.ctaSection();

    const slug = new URLSearchParams(location.search).get('slug');
    if (!slug) { document.getElementById('content').innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤</p></div>'; }

    async function load() {
      if (!slug) return;
      const content = document.getElementById('content');

      try {
        // Load basic specs from local JSON (instant)
        const localShip = await API.getLocalShip(slug);
        if (!localShip) { content.innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ì„ ë°•ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>'; return; }

        document.title = `${localShip.title} - í¬ë£¨ì¦ˆë§í¬`;
        let html = '';

        // Hero
        html += `<div class="ship-hero">
          <img src="${localShip.coverImage}" alt="${localShip.title}">
          <div class="ship-hero-overlay">
            <p>${localShip.operator} Â· ${localShip.shipClass}</p>
            <h1>${localShip.title}</h1>
          </div>
        </div>`;

        // Specs from local JSON
        html += `<section class="section"><div class="container">
          <div class="spec-grid">`;
        const specs = [
          ['ì·¨í•­ì—°ë„', localShip.launchYear || '-'], ['ë¦¬ë‰´ì–¼', localShip.refitYear || '-'],
          ['ì´í†¤ìˆ˜', localShip.grossTonnage ? localShip.grossTonnage.toLocaleString() + 't' : '-'],
          ['ì „ì¥', localShip.length ? localShip.length + 'm' : '-'],
          ['ìµœëŒ€ì •ì›', localShip.capacity ? localShip.capacity.toLocaleString() + 'ëª…' : '-'],
          ['ìŠ¹ë¬´ì›', localShip.crewCount ? localShip.crewCount.toLocaleString() + 'ëª…' : '-'],
          ['ë°í¬', localShip.deckCount ? localShip.deckCount + 'ê°œ' : '-'],
          ['ê°ì‹¤', localShip.cabinCount ? localShip.cabinCount.toLocaleString() + 'ì‹¤' : '-'],
        ];
        specs.forEach(([l, v]) => html += `<div class="spec-item"><div class="spec-label">${l}</div><div class="spec-value">${v}</div></div>`);
        html += `</div>`;

        // Tabs placeholder (will be filled by live API)
        html += `<div id="shipTabs"><div class="loading" style="padding:20px"><div class="loading-spinner"></div><p>ì‹œì„¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div></div>`;
        html += `</div></section>`;

        // Video
        if (localShip.videoUrl) {
          const vid = localShip.videoUrl.match(/(?:v=|\/)([\w-]{11})/)?.[1];
          if (vid) {
            html += `<section class="section" style="background:var(--gray-50)"><div class="container">
              <h2 class="section-title">ì„ ë°• ì˜ìƒ</h2>
              <div style="position:relative;padding-bottom:56.25%;height:0;overflow:hidden;border-radius:12px;margin-top:24px">
                <iframe src="https://www.youtube.com/embed/${vid}" style="position:absolute;top:0;left:0;width:100%;height:100%" frameborder="0" allowfullscreen loading="lazy"></iframe>
              </div>
            </div></section>`;
          }
        }

        // Cruises from local JSON
        html += `<section class="section"><div class="container">
          <h2 class="section-title">${localShip.title} í¬ë£¨ì¦ˆ ì¼ì •</h2>
          <p class="section-subtitle">ì¶œë°œì¼ ê¸°ì¤€ ì •ë ¬</p>
          <div id="shipCruises"><div class="loading"><div class="loading-spinner"></div><p>í¬ë£¨ì¦ˆ ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p></div></div>
        </div></section>`;

        content.innerHTML = html;

        // Load cruises from local JSON (instant)
        loadShipCruises();

        // Load facilities from live API (async, non-blocking)
        loadFacilities();

      } catch (e) {
        console.error(e);
        content.innerHTML = '<div class="empty-state"><span class="emoji">âš ï¸</span><p>ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p></div>';
      }
    }

    async function loadShipCruises() {
      const container = document.getElementById('shipCruises');
      const cruises = await API.getShipCruises(slug);
      container.innerHTML = cruises.length
        ? cruises.slice(0, 30).map(c => Components.localCruiseItem(c)).join('')
        : '<div class="empty-state"><span class="emoji">ğŸ“…</span><p>ì˜ˆì •ëœ í¬ë£¨ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
    }

    async function loadFacilities() {
      const tabsContainer = document.getElementById('shipTabs');
      try {
        const s = await API.getShipLive(slug);
        if (!s) { tabsContainer.innerHTML = ''; return; }

        const tabData = [];
        if (s.teaser || s.introduction) tabData.push({ id: 'overview', label: 'ğŸ“‹ ê°œìš”', content: s.teaser || s.introduction });
        if (s.accomodation_types?.length) tabData.push({ id: 'cabin', label: 'ğŸ›ï¸ ê°ì‹¤', content: '__cabins__' });
        if (s.dining?.intro) tabData.push({ id: 'dining', label: 'ğŸ½ï¸ ë‹¤ì´ë‹', content: s.dining.intro });
        if (s.entertainment?.intro) tabData.push({ id: 'entertainment', label: 'ğŸ­ ì—”í„°í…Œì¸ë¨¼íŠ¸', content: s.entertainment.intro });
        if (s.health_and_fitness?.intro) tabData.push({ id: 'spa', label: 'ğŸ’† ìŠ¤íŒŒ', content: s.health_and_fitness.intro });
        if (s.kids_and_teens?.intro) tabData.push({ id: 'kids', label: 'ğŸ‘¶ í‚¤ì¦ˆ', content: s.kids_and_teens.intro });

        if (tabData.length === 0) { tabsContainer.innerHTML = ''; return; }

        let html = `<div class="tabs">${tabData.map((t, i) => `<button class="tab-btn ${i === 0 ? 'active' : ''}" onclick="switchTab('${t.id}',this)">${t.label}</button>`).join('')}</div>`;
        tabData.forEach((t, i) => {
          let c = t.content;
          if (c === '__cabins__') {
            c = '<div class="cabin-grid">' + s.accomodation_types.map(at => {
              const img = at.images?.[0]?.href || '';
              return `<div class="cabin-card">${img ? `<img src="${img}" alt="${at.name}" loading="lazy">` : ''}<div class="cabin-card-body"><h4>${at.name}</h4></div></div>`;
            }).join('') + '</div>';
          }
          html += `<div class="tab-content ${i === 0 ? 'active' : ''}" id="tab-${t.id}">${c}</div>`;
        });
        tabsContainer.innerHTML = html;
      } catch (e) {
        tabsContainer.innerHTML = '';
      }
    }

    function switchTab(id, btn) {
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      btn.classList.add('active');
      document.getElementById('tab-' + id)?.classList.add('active');
    }

    load();
  </script>
</body>
</html>
